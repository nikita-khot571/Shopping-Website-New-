<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details - ShopZone</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-light bg-white shadow-sm">
        <div class="container d-flex align-items-center justify-content-between">
            <a class="text-decoration-none" href="index.html" style="font-weight:600; font-size:1rem;">
                <i class="fas fa-arrow-left me-2"></i>Back to shop
            </a>
            <a class="navbar-brand" href="index.html"><i class="fas fa-shopping-bag me-2"></i>ShopZone</a>
            <div class="d-none d-md-block" style="width:120px"></div>
        </div>
    </nav>

    <div class="container my-4" id="productDetailContainer">
        <div class="text-center py-5" id="loading">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">Loading product...</p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="graphql.js"></script>
    <script>
    function getQueryParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
    }

    function renderGallery(main, extras) {
        const images = [main, ...(Array.isArray(extras) ? extras : [])].filter(Boolean);
        const mainImg = images[0] || 'https://via.placeholder.com/600x400?text=No+Image';
        const thumbs = images.slice(0, 3);
        return `
        <div class="row g-3">
            <div class="col-md-2 order-2 order-md-1">
                ${thumbs.map((src, i) => `
                    <div class="mb-2">
                        <img src="${src}" class="img-fluid border rounded w-100" style="cursor:pointer" onclick="document.getElementById('mainImage').src='${src}'" onerror="this.onerror=null;this.src='https://via.placeholder.com/80x80?text=No+Image';" />
                    </div>`).join('')}
            </div>
            <div class="col-md-10 order-1 order-md-2">
                <div class="product-image bg-light d-flex align-items-center justify-content-center" style="height: 420px;">
                    <img id="mainImage" src="${mainImg}" alt="Product" class="img-fluid" onerror="this.onerror=null;this.src='https://via.placeholder.com/600x400?text=No+Image';" />
                </div>
            </div>
        </div>`;
    }

    async function loadProduct() {
        const id = getQueryParam('id');
        if (!id) return;
        const container = document.getElementById('productDetailContainer');
        try {
            const data = await graphqlService.getProductById(id);
            const p = data.product;
            if (!p) throw new Error('Product not found');

            container.innerHTML = `
            <div class="row g-4">
                <div class="col-lg-6">
                    ${renderGallery(p.image, p.images)}
                </div>
                <div class="col-lg-6">
                    <h2 class="mb-2">${p.name}</h2>
                    <div class="text-muted mb-2">${p.category}</div>
                    <div class="display-6 text-primary mb-3" style="font-weight:700;">â‚¹${parseFloat(p.price).toFixed(2)}</div>
                    <div class="mb-3"><span class="badge ${p.stock>0?'bg-success':'bg-danger'}">${p.stock>0?'In stock':'Out of stock'}</span></div>
                    <p class="mb-4">${p.description || ''}</p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-lg" onclick="window.shopZone.addToCart('${p.id}',1)"><i class="fas fa-cart-plus me-2"></i>Add to Cart</button>
                    </div>
                </div>
            </div>`;
        } catch (e) {
            container.innerHTML = `<div class="alert alert-danger">Failed to load product.</div>`;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        if (!window.graphqlService) {
            // ensure graphql service loads first (from index it attaches on DOMContentLoaded, here we include directly)
            window.graphqlService = new GraphQLService();
        }
        // Expose addToCart via app.js if available
        if (!window.shopZone || typeof window.shopZone.addToCart !== 'function') {
            window.shopZone = window.shopZone || {};
            window.shopZone.addToCart = async function(productId, qty){
                try {
                    await window.graphqlService.client.query(`mutation($productId: ID!, $quantity: Int!){ addToCart(productId:$productId, quantity:$quantity){ id } }`, {productId, quantity: qty});
                    alert('Added to cart');
                } catch(err) { console.error(err); }
            }
        }
        loadProduct();
    });
    </script>
</body>
</html>


