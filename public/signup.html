<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sign Up - ShopZone</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link href="style.css" rel="stylesheet" />
  </head>
  <body>
    <div class="container mt-5">
      <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
          <div class="card shadow">
            <div class="card-body p-4">
              <div class="text-center mb-4">
                <h2>
                  <a class="navbar-brand" href="index.html">
                    <i class="fas fa-shopping-bag me-2"></i>ShopZone
                  </a>
                </h2>
                <p class="text-muted">Create your account</p>
              </div>

              <form id="signupForm">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label class="form-label">First Name</label>
                    <input
                      type="text"
                      class="form-control"
                      id="firstName"
                      required
                    />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Last Name</label>
                    <input
                      type="text"
                      class="form-control"
                      id="lastName"
                      required
                    />
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Email</label>
                  <input
                    type="email"
                    class="form-control"
                    id="email"
                    required
                  />
                </div>
                <div class="mb-3">
                  <label class="form-label">Password</label>
                  <input
                    type="password"
                    class="form-control"
                    id="password"
                    required
                    minlength="6"
                  />
                </div>
                <button type="submit" class="btn btn-primary w-100">
                  Create Account
                </button>
              </form>

              <div class="text-center mt-3">
                <p>Already have an account? <a href="login.html">Login</a></p>
                <a href="index.html" class="text-muted">‚Üê Back to Shop</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      function showError(message) {
        // Remove existing alerts
        const existingAlert = document.querySelector(".alert");
        if (existingAlert) {
          existingAlert.remove();
        }

        const errorAlert = document.createElement("div");
        errorAlert.className = "alert alert-danger";
        errorAlert.innerHTML = `<i class="fas fa-exclamation-circle me-2"></i>${message}`;
        document
          .querySelector(".card-body")
          .insertBefore(errorAlert, document.getElementById("signupForm"));

        setTimeout(() => {
          errorAlert.remove();
        }, 5000);
      }

      function showSuccess(message) {
        const successAlert = document.createElement("div");
        successAlert.className = "alert alert-success";
        successAlert.innerHTML = `<i class="fas fa-check-circle me-2"></i>${message}`;
        document
          .querySelector(".card-body")
          .insertBefore(successAlert, document.getElementById("signupForm"));
      }

      function showLoading(show) {
        const btn = document.querySelector('#signupForm button[type="submit"]');
        if (!btn) return;
        btn.disabled = !!show;
        btn.innerHTML = show ? '<span class="spinner-border spinner-border-sm me-2"></span>Creating Account‚Ä¶' : 'Create Account';
      }

      document
        .getElementById("signupForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const firstName = document.getElementById("firstName").value.trim();
          const lastName = document.getElementById("lastName").value.trim();
          const email = document.getElementById("email").value.trim();
          const password = document.getElementById("password").value;

          // Validation
          if (!firstName || !lastName || !email || !password) {
            showError("Please fill in all required fields");
            return;
          }

          if (password.length < 6) {
            showError("Password must be at least 6 characters long");
            return;
          }

          if (!email.includes("@")) {
            showError("Please enter a valid email address");
            return;
          }

          showLoading(true);

          try {
            console.log("üîÑ Attempting registration for:", email);

            const response = await fetch("http://localhost:4001/graphql", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                query: `
                          mutation RegisterUser($email: String!, $password: String!, $firstName: String!, $lastName: String!) {
                              register(email: $email, password: $password, firstName: $firstName, lastName: $lastName) {
                                  token
                                  user {
                                      id
                                      firstName
                                      lastName
                                      email
                                      role
                                  }
                              }
                          }
                      `,
                variables: { email, password, firstName, lastName },
              }),
            });

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: Server error`);
            }

            const data = await response.json();
            console.log("üì¶ Registration response:", data);

            if (data.errors) {
              throw new Error(data.errors[0].message);
            }

            if (data.data?.register) {
              showSuccess("Account created successfully! Redirecting to login...");
              // After signup, send user to login page
              setTimeout(() => {
                window.location.href = "login.html";
              }, 1200);
            } else {
              throw new Error(
                "Registration failed: Invalid response from server"
              );
            }
          } catch (error) {
            console.error("‚ùå Registration error:", error);
            showError(
              error.message || "Registration failed. Please try again."
            );
          } finally {
            showLoading(false);
          }
        });
    </script>
  </body>
</html>
