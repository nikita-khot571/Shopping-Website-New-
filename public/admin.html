<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - ShopZone</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
    <style>
        
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-white bg-primary shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="container-fluid">
            <a class="brand-name-black" href="index.html">
                <i class="fas fa-shield-alt me-2"></i>ShopZone Admin
            </a>
            
            <div class="navbar-nav ms-auto flex-row">
                <span class="navbar-text me-3 ">
                    <i class="fas fa-user-circle me-1 "></i>
                    <span id="adminName">Admin</span>
                </span>
                <a class="nav-link me-3 " href="index.html">
                    <i class="fas fa-store me-1"></i>View Store
                </a>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-1"></i>Logout
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3 col-lg-2 sidebar p-0">
                <div class="p-3">
                    <h6 class="text-muted">DASHBOARD</h6>
                    <ul class="nav nav-pills flex-column">
                        <li class="nav-item mb-1">
                            <a class="nav-link active" href="#dashboard" onclick="showSection('dashboard', event)">
                                <i class="fas fa-tachometer-alt me-2"></i>Overview
                            </a>
                        </li>
                        <li class="nav-item mb-1">
                            <a class="nav-link" href="#products" onclick="showSection('products', event)">
                                <i class="fas fa-box me-2"></i>Products
                            </a>
                        </li>
                        <li class="nav-item mb-1">
                            <a class="nav-link" href="#orders" onclick="showSection('orders', event)">
                                <i class="fas fa-shopping-cart me-2"></i>Orders
                            </a>
                        </li>
                        <li class="nav-item mb-1">
                            <a class="nav-link" href="#users" onclick="showSection('users', event)">
                                <i class="fas fa-users me-2"></i>Users
                            </a>
                        </li>
                       
                    </ul>
                </div>
            </div>

            <div class="col-md-9 col-lg-10 p-4">
                <div id="dashboardSection" class="section-content">
                    <h2 class="mb-4"><i class="fas fa-tachometer-alt me-2"></i>Dashboard Overview</h2>
                    
                    <div class="row mb-4">
                        <div class="col-md-3 mb-3">
                            <div class="card stat-card">
                                <div class="card-body text-center">
                                    <i class="fas fa-box fa-2x mb-2"></i>
                                    <h4 id="totalProducts">0</h4>
                                    <p class="mb-0">Total Products</p>
                                    <small class="opacity-75" id="productsChange">+0% from last month</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card stat-card">
                                <div class="card-body text-center">
                                    <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                                    <h4 id="totalOrders">0</h4>
                                    <p class="mb-0">Total Orders</p>
                                    <small class="opacity-75" id="ordersChange">+0% from last month</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card stat-card">
                                <div class="card-body text-center">
                                    <i class="fas fa-users fa-2x mb-2"></i>
                                    <h4 id="totalUsers">0</h4>
                                    <p class="mb-0">Total Users</p>
                                    <small class="opacity-75" id="usersChange">+0% from last month</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card stat-card">
                                <div class="card-body text-center">
                                    <i class="fas fa-dollar-sign fa-2x mb-2"></i>
                                    <h4 id="totalRevenue">â‚¹0</h4>
                                    <p class="mb-0">Total Revenue</p>
                                    <small class="opacity-75" id="revenueChange">+0% from last month</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card admin-card">
                                <div class="card-header">
                                    <h5><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <button class="btn btn-primary w-100" onclick="showAddProductModal()">
                                                <i class="fas fa-plus me-2"></i>Add Product
                                            </button>
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <button class="btn btn-info w-100" onclick="showSection('orders', event)">
                                                <i class="fas fa-eye me-2"></i>View Orders
                                            </button>
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <button class="btn btn-success w-100" onclick="showSection('users', event)">
                                                <i class="fas fa-users me-2"></i>Manage Users
                                            </button>
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <button class="btn btn-warning w-100" onclick="exportData()">
                                                <i class="fas fa-download me-2"></i>Export Data
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-8 mb-4">
                            <div class="card admin-card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5><i class="fas fa-clock me-2"></i>Recent Orders</h5>
                                    <a href="#orders" onclick="showSection('orders', event)" class="btn btn-sm btn-outline-primary">View All</a>
                                </div>
                                <div class="card-body recent-orders" id="recentOrdersContainer">
                                    <div class="loading-spinner">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-4 mb-4">
                            <div class="card admin-card">
                                <div class="card-header">
                                    <h5><i class="fas fa-chart-pie me-2"></i>Order Status</h5>
                                </div>
                                <div class="card-body" id="orderStatusChart">
                                    <div class="loading-spinner">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="productsSection" class="section-content" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="fas fa-box me-2"></i>Product Management</h2>
                        <div>
                            <button class="btn btn-outline-secondary me-2" onclick="exportProducts()">
                                <i class="fas fa-download me-2"></i>Export
                            </button>
                            <button class="btn btn-primary" onclick="showAddProductModal()">
                                <i class="fas fa-plus me-2"></i>Add Product
                            </button>
                        </div>
                    </div>
                    
                   
                    
                    <div class="card admin-card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Image</th>
                                            <th>Name</th>
                                            <th>Category</th>
                                            <th>Price</th>
                                            <th>Stock</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="productsTableBody">
                                        <tr>
                                            <td colspan="7" class="text-center">
                                                <div class="loading-spinner">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="ordersSection" class="section-content" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="fas fa-shopping-cart me-2"></i>Order Management</h2>
                        <button class="btn btn-outline-secondary" onclick="exportOrders()">
                            <i class="fas fa-download me-2"></i>Export Orders
                        </button>
                    </div>
                    
                  
                    
                    <div class="card admin-card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Order ID</th>
                                            <th>Customer</th>
                                            <th>Items</th>
                                            <th>Total</th>
                                            <th>Status</th>
                                            <th>Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ordersTableBody">
                                        <tr>
                                            <td colspan="7" class="text-center">
                                                <div class="loading-spinner">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="usersSection" class="section-content" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="fas fa-users me-2"></i>User Management</h2>
                        <button class="btn btn-outline-secondary" onclick="exportUsers()">
                            <i class="fas fa-download me-2"></i>Export Users
                        </button>
                    </div>
                    
                   
                    <div class="card admin-card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>Email</th>
                                            <th>Role</th>
                                            <th>Joined</th>
                                            <th>Orders</th>
                                            <th>Total Spent</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersTableBody">
                                        <tr>
                                            <td colspan="7" class="text-center">
                                                <div class="loading-spinner">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

               
            </div>
        </div>
    </div>

    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalTitle">Add Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="productId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Product Name *</label>
                                <input type="text" class="form-control" id="productName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Category *</label>
                                <select class="form-control" id="productCategory" required>
                                    <option value="">Select Category</option>
                                    <option value="electronics">Electronics</option>
                                    <option value="books">Books</option>
                                    <option value="clothing">Clothing</option>
                                    <option value="home">Home</option>
                                    <option value="sports">Sports</option>
                                    <option value="toys">Toys</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Price (â‚¹) *</label>
                                <input type="number" step="0.01" class="form-control" id="productPrice" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Stock Quantity *</label>
                                <input type="number" class="form-control" id="productStock" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="productDescription" rows="3" placeholder="Enter product description..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Image URL</label>
                            <input type="url" class="form-control" id="productImage" placeholder="https://example.com/image.jpg">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Additional Image URL 2</label>
                                <input type="url" class="form-control" id="productImage2" placeholder="https://example.com/image2.jpg">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Additional Image URL 3</label>
                                <input type="url" class="form-control" id="productImage3" placeholder="https://example.com/image3.jpg">
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="productActive" checked>
                                <label class="form-check-label" for="productActive">
                                    Product is active and visible to customers
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveProduct()">
                        <i class="fas fa-save me-2"></i>Save Product
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="orderModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Order Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="orderDetailsBody">
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="printOrderBtn" onclick="printOrder()">
                        <i class="fas fa-print me-2"></i>Print
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">User Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="userDetailsBody">
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="graphql.js"></script>
    
    <script>
        let currentUser = null;
        let products = [];
        let orders = [];
        let users = [];
        let salesChart = null;
        let categoryChart = null;

        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAuth();
            loadDashboardData();
        });

        function checkAdminAuth() {
            const user = JSON.parse(localStorage.getItem('currentUser') || 'null');
            const token = localStorage.getItem('authToken');
            
            if (!user || !token || user.role !== 'admin') {
                alert('Admin access required. Please login as admin.');
                window.location.href = 'login.html';
                return;
            }
            
            currentUser = user;
            window.user = user; // Fix for ReferenceError: user is not defined in admin page scripts
            document.getElementById('adminName').textContent = `${user.firstName} ${user.lastName}`;
        }

        async function loadDashboardData() {
            try {
                await Promise.all([
                    loadProducts(),
                    loadOrders(),
                    loadUsers()
                ]);
                
                updateStats();
                loadRecentOrders();
                loadOrderStatusChart();
                loadTopProducts();
            } catch (error) {
                console.error('Dashboard data loading error:', error);
               //  showToast('Failed to load dashboard data', 'danger');
            }
        }

        async function loadProducts() {
            try {
                const response = await fetch('http://localhost:4001/graphql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        query: `
                            query GetProducts {
                                products {
                                    id
                                    name
                                    description
                                    price
                                    category
                                    image
                                    stock
                                    createdAt
                                }
                            }
                        `
                    })
                });

                const data = await response.json();
                if (data.errors) {
                    const errorMessage = data.errors.map(err => err.message).join(', ');
                    throw new Error(`GraphQL Error: ${errorMessage}`);
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                products = data.data.products || [];
                renderProductsTable();
            } catch (error) {
                console.error('Error loading products:', error);
                showToast(`Failed to load products: ${error.message}`, 'danger');
            }
        }

        async function loadOrders() {
            try {
                const response = await fetch('http://localhost:4001/graphql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        query: `
                            query GetAllOrders {
                                allOrders {
                                    id
                                    total
                                    status
                                    createdAt
                                    user {
                                        id
                                        firstName
                                        lastName
                                        email
                                    }
                                    items {
                                        id
                                        quantity
                                        price
                                        product {
                                            id
                                            name
                                        }
                                    }
                                }
                            }
                        `
                    })
                });

                const data = await response.json();
                if (data.errors) {
                    const errorMessage = data.errors.map(err => err.message).join(', ');
                    throw new Error(`GraphQL Error: ${errorMessage}`);
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                orders = data.data.allOrders || [];
                renderOrdersTable();
            } catch (error) {
                console.error('Error loading orders:', error);
                 showToast(`Failed to load orders: ${error.message}`, 'danger');
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch('http://localhost:4001/graphql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        query: `
                            query GetUsers {
                                users {
                                    id
                                    firstName
                                    lastName
                                    email
                                    role
                                    createdAt
                                }
                            }
                        `
                    })
                });

                const data = await response.json();
                if (data.errors) {
                    const errorMessage = data.errors.map(err => err.message).join(', ');
                    throw new Error(`GraphQL Error: ${errorMessage}`);
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                users = data.data.users || [];
                renderUsersTable();
            } catch (error) {
                console.error('Error loading users:', error);
                showToast(`Failed to load users: ${error.message}`, 'danger');
            }
        }

        function updateStats() {
            document.getElementById('totalProducts').textContent = products.length;
            document.getElementById('totalOrders').textContent = orders.length;
            document.getElementById('totalUsers').textContent = users.length;
            
            const totalRevenue = orders.reduce((sum, order) => sum + parseFloat(order.total), 0);
            document.getElementById('totalRevenue').textContent = `â‚¹${totalRevenue.toFixed(2)}`;
            
            // Calculate percentage changes (mock data - in real app would compare with previous period)
            document.getElementById('productsChange').textContent = '+12% from last month';
            document.getElementById('ordersChange').textContent = '+25% from last month';
            document.getElementById('usersChange').textContent = '+8% from last month';
            document.getElementById('revenueChange').textContent = '+18% from last month';
        }

        function loadRecentOrders() {
            const recentOrders = orders.slice(0, 5);
            const container = document.getElementById('recentOrdersContainer');
            
            if (recentOrders.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No recent orders</p>';
                return;
            }
            
            container.innerHTML = recentOrders.map(order => `
                <div class="order-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Order #${order.id.slice(-8)}</h6>
                            <small class="text-muted">
                                <i class="fas fa-user me-1"></i>${order.user ? `${order.user.firstName} ${order.user.lastName}` : 'Unknown User'}
                            </small>
                            <small class="text-muted ms-2">
                                <i class="fas fa-clock me-1"></i>${new Date(order.createdAt).toLocaleDateString()}
                            </small>
                        </div>
                        <div class="text-end">
                            <h6 class="mb-1 text-primary">â‚¹${parseFloat(order.total).toFixed(2)}</h6>
                            <span class="badge bg-${getStatusColor(order.status)} status-badge">${order.status}</span>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">${order.items ? order.items.length : 0} item(s)</small>
                        <button class="btn btn-sm btn-outline-primary float-end" onclick="viewOrder('${order.id}')">
                            View Details
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function loadOrderStatusChart() {
            const statusCounts = {
                pending: 0,
                processing: 0,
                shipped: 0,
                delivered: 0,
                cancelled: 0
            };
            
            orders.forEach(order => {
                if (statusCounts.hasOwnProperty(order.status)) {
                    statusCounts[order.status]++;
                }
            });
            
            const container = document.getElementById('orderStatusChart');
            container.innerHTML = `
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span><i class="fas fa-circle text-warning me-2"></i>Pending</span>
                        <strong>${statusCounts.pending}</strong>
                    </div>
                    <div class="progress mb-3" style="height: 8px;">
                        <div class="progress-bar bg-warning" style="width: ${(statusCounts.pending/orders.length*100)||0}%"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span><i class="fas fa-circle text-info me-2"></i>Processing</span>
                        <strong>${statusCounts.processing}</strong>
                    </div>
                    <div class="progress mb-3" style="height: 8px;">
                        <div class="progress-bar bg-info" style="width: ${(statusCounts.processing/orders.length*100)||0}%"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span><i class="fas fa-circle text-primary me-2"></i>Shipped</span>
                        <strong>${statusCounts.shipped}</strong>
                    </div>
                    <div class="progress mb-3" style="height: 8px;">
                        <div class="progress-bar bg-primary" style="width: ${(statusCounts.shipped/orders.length*100)||0}%"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span><i class="fas fa-circle text-success me-2"></i>Delivered</span>
                        <strong>${statusCounts.delivered}</strong>
                    </div>
                    <div class="progress mb-3" style="height: 8px;">
                        <div class="progress-bar bg-success" style="width: ${(statusCounts.delivered/orders.length*100)||0}%"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span><i class="fas fa-circle text-danger me-2"></i>Cancelled</span>
                        <strong>${statusCounts.cancelled}</strong>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-danger" style="width: ${(statusCounts.cancelled/orders.length*100)||0}%"></div>
                    </div>
                </div>
            `;
        }

        function loadTopProducts() {
            // Calculate product sales from orders
            const productSales = {};
            orders.forEach(order => {
                if (order.items && Array.isArray(order.items)) {
                    order.items.forEach(item => {
                        if (item.product && item.product.id) {
                            if (!productSales[item.product.id]) {
                                productSales[item.product.id] = {
                                    name: item.product.name,
                                    quantity: 0,
                                    revenue: 0
                                };
                            }
                            productSales[item.product.id].quantity += item.quantity;
                            productSales[item.product.id].revenue += item.quantity * parseFloat(item.price);
                        }
                    });
                }
            });
            
            const topProducts = Object.values(productSales)
                .sort((a, b) => b.revenue - a.revenue)
                .slice(0, 5);
            
            const container = document.getElementById('topProductsContainer');
            
            if (topProducts.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No sales data available</p>';
                return;
            }
            
            container.innerHTML = topProducts.map((product, index) => `
                <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
                    <div>
                        <span class="badge bg-primary me-2">#${index + 1}</span>
                        <strong>${product.name}</strong>
                        <div class="small text-muted">${product.quantity} units sold</div>
                    </div>
                    <div class="text-end">
                        <strong class="text-success">â‚¹${product.revenue.toFixed(2)}</strong>
                    </div>
                </div>
            `).join('');
        }

        function loadRecentActivity() {
            const activities = [];
            
            // Add recent orders
            orders.slice(0, 3).forEach(order => {
                if (order.user && order.user.firstName) {
                    activities.push({
                        type: 'order',
                        icon: 'fa-shopping-cart',
                        color: 'primary',
                        message: `New order #${order.id.slice(-8)} from ${order.user.firstName}`,
                        time: order.createdAt
                    });
                }
            });
            
            // Add recent user registrations
            users.slice(-3).forEach(user => {
                activities.push({
                    type: 'user',
                    icon: 'fa-user-plus',
                    color: 'success',
                    message: `${user.firstName} ${user.lastName} registered`,
                    time: user.createdAt
                });
            });
            
            // Sort by time
            activities.sort((a, b) => new Date(b.time) - new Date(a.time));
            
            const container = document.getElementById('recentActivityContainer');
            
            if (activities.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No recent activity</p>';
                return;
            }
            
            container.innerHTML = activities.slice(0, 8).map(activity => `
                <div class="d-flex align-items-start mb-3 pb-3 border-bottom">
                    <div class="me-3">
                        <div class="rounded-circle bg-${activity.color} text-white p-2" style="width: 35px; height: 35px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas ${activity.icon} fa-sm"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1">
                        <div>${activity.message}</div>
                        <small class="text-muted">${new Date(activity.time).toLocaleString()}</small>
                    </div>
                </div>
            `).join('');
        }

        function renderProductsTable() {
            const tbody = document.getElementById('productsTableBody');
            
            if (products.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">
                            <div class="empty-state">
                                <i class="fas fa-box fa-3x mb-3"></i>
                                <h5>No products found</h5>
                                <p>Start by adding your first product</p>
                                <button class="btn btn-primary" onclick="showAddProductModal()">
                                    <i class="fas fa-plus me-2"></i>Add Product
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = products.map(product => `
                <tr>
                                    <td>
                                        <div class="product-image-preview bg-light d-flex align-items-center justify-content-center">
                                            <img src="${product.image || 'https://via.placeholder.com/50x50?text=No+Image'}" alt="${product.name}" class="img-fluid" onerror="this.onerror=null;this.src='https://via.placeholder.com/50x50?text=No+Image';" />
                                        </div>
                                    </td>
                    <td>
                        <div>
                            <h6 class="mb-1">${product.name}</h6>
                            <small class="text-muted">${(product.description || 'No description').substring(0, 50)}${product.description && product.description.length > 50 ? '...' : ''}</small>
                        </div>
                    </td>
                    <td><span class="badge bg-secondary">${product.category}</span></td>
                    <td><strong>â‚¹${parseFloat(product.price).toFixed(2)}</strong></td>
                    <td>
                        <span class="badge ${product.stock > 10 ? 'bg-success' : product.stock > 0 ? 'bg-warning' : 'bg-danger'}">
                            ${product.stock}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${product.stock > 0 ? 'bg-success' : 'bg-danger'}">
                            ${product.stock > 0 ? 'In Stock' : 'Out of Stock'}
                        </span>
                    </td>
                    <td class="table-actions">
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editProduct('${product.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${product.id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderOrdersTable() {
            const tbody = document.getElementById('ordersTableBody');
            
            if (orders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">
                            <div class="empty-state">
                                <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                                <h5>No orders found</h5>
                                <p>Orders will appear here once customers start purchasing</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = orders.map(order => `
                <tr>
                    <td><strong>#${order.id.slice(-8)}</strong></td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="user-avatar me-2">
                                <i class="fas fa-user"></i>
                            </div>
                            <div>
                                <div>${order.user.firstName} ${order.user.lastName}</div>
                                <small class="text-muted">${order.user.email}</small>
                            </div>
                        </div>
                    </td>
                    <td>${order.items.length}</td>
                    <td><strong class="text-primary">â‚¹${parseFloat(order.total).toFixed(2)}</strong></td>
                    <td><span class="badge bg-${getStatusColor(order.status)} status-badge">${order.status}</span></td>
                    <td><small>${new Date(order.createdAt).toLocaleDateString()}</small></td>
                    <td class="table-actions">
                        <button class="btn btn-sm btn-outline-info me-1" onclick="viewOrder('${order.id}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <select class="form-select form-select-sm d-inline-block w-auto" onchange="updateOrderStatus('${order.id}', this.value)" style="font-size: 0.75rem;">
                            <option value="">Change Status</option>
                            <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>Processing</option>
                            <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Shipped</option>
                            <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                            <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                        </select>
                    </td>
                </tr>
            `).join('');
        }

        function renderUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            
            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">
                            <div class="empty-state">
                                <i class="fas fa-users fa-3x mb-3"></i>
                                <h5>No users found</h5>
                                <p>Registered users will appear here</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = users.map(user => {
                const userOrders = orders.filter(order => order.user.id === user.id);
                const totalSpent = userOrders.reduce((sum, order) => sum + parseFloat(order.total), 0);
                
                return `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="user-avatar me-2">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div>
                                    <strong>${user.firstName} ${user.lastName}</strong>
                                </div>
                            </div>
                        </td>
                        <td>${user.email}</td>
                        <td><span class="badge ${user.role === 'admin' ? 'bg-danger' : 'bg-primary'}">${user.role}</span></td>
                        <td><small>${new Date(user.createdAt).toLocaleDateString()}</small></td>
                        <td><strong>${userOrders.length}</strong></td>
                        <td><strong class="text-success">â‚¹${totalSpent.toFixed(2)}</strong></td>
                        <td class="table-actions">
                            <button class="btn btn-sm btn-outline-info" onclick="viewUserDetails('${user.id}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function showSection(sectionName, event) {
            event.preventDefault(); // Prevent the default anchor link behavior
            
            // Hide all sections
            document.querySelectorAll('.section-content').forEach(section => {
                section.style.display = 'none';
            });
            
            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName + 'Section').style.display = 'block';
            
            // Add active class to clicked nav link
            event.target.classList.add('active');
            
            // Load section-specific data
            // if (sectionName === 'analytics') {
            //     loadAnalytics();
            // }
        }

        function showAddProductModal() {
            document.getElementById('productModalTitle').textContent = 'Add Product';
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('productActive').checked = true;
            new bootstrap.Modal(document.getElementById('productModal')).show();
        }

        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            document.getElementById('productModalTitle').textContent = 'Edit Product';
            document.getElementById('productId').value = product.id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productStock').value = product.stock;
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productImage').value = product.image || '';
            const imgs = Array.isArray(product.images) ? product.images : [];
            document.getElementById('productImage2').value = imgs[0] || '';
            document.getElementById('productImage3').value = imgs[1] || '';
            
            new bootstrap.Modal(document.getElementById('productModal')).show();
        }

        async function saveProduct() {
            const productId = document.getElementById('productId').value;
            const productData = {
                name: document.getElementById('productName').value.trim(),
                category: document.getElementById('productCategory').value,
                price: parseFloat(document.getElementById('productPrice').value),
                stock: parseInt(document.getElementById('productStock').value),
                description: document.getElementById('productDescription').value.trim(),
                image: document.getElementById('productImage').value.trim() || null,
                images: [
                    document.getElementById('productImage2').value.trim(),
                    document.getElementById('productImage3').value.trim()
                ].filter(Boolean)
            };
            
            if (!productData.name || !productData.category || isNaN(productData.price) || isNaN(productData.stock)) {
                showToast('Please fill in all required fields', 'danger');
                return;
            }
            
            try {
                let mutation;
                let query;
                let variables;

                if (productId) {
                    // Update mutation
                    query = `
                        mutation UpdateProduct($id: ID!, $name: String!, $description: String, $price: Float!, $category: String!, $image: String, $images: [String], $stock: Int!) {
                            updateProduct(id: $id, name: $name, description: $description, price: $price, category: $category, image: $image, images: $images, stock: $stock) {
                                id
                                name
                                description
                                price
                                category
                                image
                                images
                                stock
                                createdAt
                            }
                        }
                    `;
                    variables = { id: productId, ...productData };
                } else {
                    // Create mutation
                    query = `
                        mutation CreateProduct($name: String!, $description: String, $price: Float!, $category: String!, $image: String, $images: [String], $stock: Int!) {
                            createProduct(name: $name, description: $description, price: $price, category: $category, image: $image, images: $images, stock: $stock) {
                                id
                                name
                                description
                                price
                                category
                                image
                                images
                                stock
                                createdAt
                            }
                        }
                    `;
                    variables = productData;
                }

                const response = await fetch('http://localhost:4001/graphql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        query: query,
                        variables: variables
                    })
                });
                
                const data = await response.json();
                if (data.errors) {
                    throw new Error(data.errors[0].message);
                }
                
                showToast(`Product ${productId ? 'updated' : 'created'} successfully!`, 'success');
                bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
                await loadProducts();
                updateStats();
                
            } catch (error) {
                console.error('Error saving product:', error);
                showToast('Failed to save product: ' + error.message, 'danger');
            }
        }

        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product? This action cannot be undone.')) return;
            
            try {
                const response = await fetch('http://localhost:4001/graphql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        query: `
                            mutation DeleteProduct($id: ID!) {
                                deleteProduct(id: $id)
                            }
                        `,
                        variables: { id: productId }
                    })
                });
                
                const data = await response.json();
                if (data.errors) {
                    throw new Error(data.errors[0].message);
                }
                
                showToast('Product deleted successfully!', 'success');
                await loadProducts();
                updateStats();
                
            } catch (error) {
                console.error('Error deleting product:', error);
                showToast('Failed to delete product: ' + error.message, 'danger');
            }
        }

        async function updateOrderStatus(orderId, newStatus) {
            if (!newStatus || newStatus === '') return;
            
            try {
                const response = await fetch('http://localhost:4001/graphql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        query: `
                            mutation UpdateOrderStatus($id: ID!, $status: String!) {
                                updateOrderStatus(id: $id, status: $status) {
                                    id
                                    status
                                }
                            }
                        `,
                        variables: { id: orderId, status: newStatus }
                    })
                });
                
                const data = await response.json();
                if (data.errors) {
                    throw new Error(data.errors[0].message);
                }
                
                showToast('Order status updated successfully!', 'success');
                await loadOrders();
                loadRecentOrders();
                loadOrderStatusChart();
                
            } catch (error) {
                console.error('Error updating order status:', error);
                showToast('Failed to update order status: ' + error.message, 'danger');
            }
        }

        function viewOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            const orderDetailsBody = document.getElementById('orderDetailsBody');
            orderDetailsBody.innerHTML = `
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6><i class="fas fa-info-circle me-2"></i>Order Information</h6>
                        <table class="table table-sm table-borderless">
                            <tr>
                                <td><strong>Order ID:</strong></td>
                                <td>#${order.id.slice(-8)}</td>
                            </tr>
                            <tr>
                                <td><strong>Date:</strong></td>
                                <td>${new Date(order.createdAt).toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td><strong>Status:</strong></td>
                                <td><span class="badge bg-${getStatusColor(order.status)}">${order.status}</span></td>
                            </tr>
                            <tr>
                                <td><strong>Total:</strong></td>
                                <td><strong class="text-primary">â‚¹${parseFloat(order.total).toFixed(2)}</strong></td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-user me-2"></i>Customer Information</h6>
                        <table class="table table-sm table-borderless">
                            <tr>
                                <td><strong>Name:</strong></td>
                                <td>${order.user.firstName} ${order.user.lastName}</td>
                            </tr>
                            <tr>
                                <td><strong>Email:</strong></td>
                                <td>${order.user.email}</td>
                            </tr>
                            <tr>
                                <td><strong>Customer ID:</strong></td>
                                <td>#${order.user.id.slice(-8)}</td>
                            </tr>
                        </table>
                    </div>
                </div>
                <hr>
                <h6><i class="fas fa-shopping-bag me-2"></i>Order Items</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Product</th>
                                <th class="text-center">Quantity</th>
                                <th class="text-end">Price</th>
                                <th class="text-end">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${order.items.map(item => `
                                <tr>
                                    <td>${item.product.name}</td>
                                    <td class="text-center">${item.quantity}</td>
                                    <td class="text-end">â‚¹${parseFloat(item.price).toFixed(2)}</td>
                                    <td class="text-end">â‚¹${(parseFloat(item.price) * item.quantity).toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <td colspan="3" class="text-end"><strong>Total:</strong></td>
                                <td class="text-end"><strong class="text-primary">â‚¹${parseFloat(order.total).toFixed(2)}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
            
            new bootstrap.Modal(document.getElementById('orderModal')).show();
        }

        function viewUserDetails(userId) {
            const user = users.find(u => u.id === userId);
            const userOrders = orders.filter(order => order.user.id === userId);
            const totalSpent = userOrders.reduce((sum, order) => sum + parseFloat(order.total), 0);
            
            if (!user) return;
            
            const userDetailsBody = document.getElementById('userDetailsBody');
            userDetailsBody.innerHTML = `
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6><i class="fas fa-user me-2"></i>User Information</h6>
                        <table class="table table-sm table-borderless">
                            <tr>
                                <td><strong>Name:</strong></td>
                                <td>${user.firstName} ${user.lastName}</td>
                            </tr>
                            <tr>
                                <td><strong>Email:</strong></td>
                                <td>${user.email}</td>
                            </tr>
                            <tr>
                                <td><strong>Role:</strong></td>
                                <td><span class="badge ${user.role === 'admin' ? 'bg-danger' : 'bg-primary'}">${user.role}</span></td>
                            </tr>
                            <tr>
                                <td><strong>Joined:</strong></td>
                                <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-chart-line me-2"></i>Order Statistics</h6>
                        <table class="table table-sm table-borderless">
                            <tr>
                                <td><strong>Total Orders:</strong></td>
                                <td><span class="badge bg-info">${userOrders.length}</span></td>
                            </tr>
                            <tr>
                                <td><strong>Total Spent:</strong></td>
                                <td><strong class="text-success">â‚¹${totalSpent.toFixed(2)}</strong></td>
                            </tr>
                            <tr>
                                <td><strong>Avg Order:</strong></td>
                                <td>â‚¹${userOrders.length > 0 ? (totalSpent / userOrders.length).toFixed(2) : '0.00'}</td>
                            </tr>
                        </table>
                    </div>
                </div>
                <hr>
                <h6><i class="fas fa-history me-2"></i>Order History</h6>
                ${userOrders.length > 0 ? `
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Order ID</th>
                                    <th>Date</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${userOrders.map(order => `
                                    <tr>
                                        <td>#${order.id.slice(-8)}</td>
                                        <td>${new Date(order.createdAt).toLocaleDateString()}</td>
                                        <td>${order.items.length}</td>
                                        <td>â‚¹${parseFloat(order.total).toFixed(2)}</td>
                                        <td><span class="badge bg-${getStatusColor(order.status)}">${order.status}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                ` : '<p class="text-muted text-center">No orders yet</p>'}
            `;
            
            new bootstrap.Modal(document.getElementById('userModal')).show();
        }

        function getStatusColor(status) {
            switch (status.toLowerCase()) {
                case 'pending': return 'warning';
                case 'processing': return 'info';
                case 'shipped': return 'primary';
                case 'delivered': return 'success';
                case 'customer_cancelled': return 'dark';
                case 'cancelled': return 'danger';
                default: return 'secondary';
            }
        }

        function filterProducts() {
            const searchTerm = document.getElementById('productSearchInput').value.toLowerCase();
            const category = document.getElementById('productCategoryFilter').value;
            const stockLevel = document.getElementById('productStockFilter').value;
            
            let filtered = products;
            
            if (searchTerm) {
                filtered = filtered.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) || 
                    (p.description && p.description.toLowerCase().includes(searchTerm))
                );
            }
            
            if (category) {
                filtered = filtered.filter(p => p.category === category);
            }
            
            if (stockLevel) {
                switch(stockLevel) {
                    case 'instock':
                        filtered = filtered.filter(p => p.stock > 10);
                        break;
                    case 'lowstock':
                        filtered = filtered.filter(p => p.stock > 0 && p.stock <= 10);
                        break;
                    case 'outofstock':
                        filtered = filtered.filter(p => p.stock === 0);
                        break;
                }
            }
            
            // Temporarily replace products array for rendering
            const originalProducts = products;
            products = filtered;
            renderProductsTable();
            products = originalProducts;
        }

        function filterOrders() {
            const searchTerm = document.getElementById('orderSearchInput').value.toLowerCase();
            const status = document.getElementById('orderStatusFilter').value;
            const dateFrom = document.getElementById('orderDateFrom').value;
            const dateTo = document.getElementById('orderDateTo').value;
            
            let filtered = orders;
            
            if (searchTerm) {
                filtered = filtered.filter(o => 
                    o.id.toLowerCase().includes(searchTerm) ||
                    o.user.firstName.toLowerCase().includes(searchTerm) ||
                    o.user.lastName.toLowerCase().includes(searchTerm) ||
                    o.user.email.toLowerCase().includes(searchTerm)
                );
            }
            
            if (status) {
                filtered = filtered.filter(o => o.status === status);
            }
            
            if (dateFrom) {
                filtered = filtered.filter(o => new Date(o.createdAt) >= new Date(dateFrom));
            }
            
            if (dateTo) {
                filtered = filtered.filter(o => new Date(o.createdAt) <= new Date(dateTo + 'T23:59:59'));
            }
            
            const originalOrders = orders;
            orders = filtered;
            renderOrdersTable();
            orders = originalOrders;
        }

        function clearOrderFilters() {
            document.getElementById('orderSearchInput').value = '';
            document.getElementById('orderStatusFilter').value = '';
            document.getElementById('orderDateFrom').value = '';
            document.getElementById('orderDateTo').value = '';
            renderOrdersTable();
        }

        function filterUsers() {
            const searchTerm = document.getElementById('userSearchInput').value.toLowerCase();
            const role = document.getElementById('userRoleFilter').value;
            
            let filtered = users;
            
            if (searchTerm) {
                filtered = filtered.filter(u => 
                    u.firstName.toLowerCase().includes(searchTerm) ||
                    u.lastName.toLowerCase().includes(searchTerm) ||
                    u.email.toLowerCase().includes(searchTerm)
                );
            }
            
            if (role) {
                filtered = filtered.filter(u => u.role === role);
            }
            
            const originalUsers = users;
            users = filtered;
            renderUsersTable();
            users = originalUsers;
        }

        function clearUserFilters() {
            document.getElementById('userSearchInput').value = '';
            document.getElementById('userRoleFilter').value = '';
            document.getElementById('userActivityFilter').value = '';
            renderUsersTable();
        }

        function loadAnalytics() {
            // Load sales chart
            const ctx = document.getElementById('salesChart');
            if (ctx && ctx.getContext) {
                // Generate monthly sales data
                const monthlyData = generateMonthlySales();
                
                if (salesChart) {
                    salesChart.destroy();
                }
                
                salesChart = new Chart(ctx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                        datasets: [{
                            label: 'Revenue (â‚¹)',
                            data: monthlyData,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'â‚¹' + value;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Load category chart
            const categoryCtx = document.getElementById('categoryChart');
            if (categoryCtx && categoryCtx.getContext) {
                const categoryData = generateCategoryData();
                
                if (categoryChart) {
                    categoryChart.destroy();
                }
                
                categoryChart = new Chart(categoryCtx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(categoryData),
                        datasets: [{
                            data: Object.values(categoryData),
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.8)',
                                'rgba(54, 162, 235, 0.8)',
                                'rgba(255, 206, 86, 0.8)',
                                'rgba(75, 192, 192, 0.8)',
                                'rgba(153, 102, 255, 0.8)',
                                'rgba(255, 159, 64, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }

        function generateMonthlySales() {
            const monthly = new Array(12).fill(0);
            orders.forEach(order => {
                const month = new Date(order.createdAt).getMonth();
                monthly[month] += parseFloat(order.total);
            });
            return monthly;
        }

        function generateCategoryData() {
            const categories = {};
            orders.forEach(order => {
                order.items.forEach(item => {
                    const product = products.find(p => p.id === item.product.id);
                    if (product) {
                        const cat = product.category;
                        categories[cat] = (categories[cat] || 0) + (item.quantity * parseFloat(item.price));
                    }
                });
            });
            return categories;
        }

        function exportData() {
            showToast('Export functionality coming soon!', 'info');
        }

        function exportProducts() {
            const csv = convertToCSV(products, ['id', 'name', 'category', 'price', 'stock', 'createdAt']);
            downloadCSV(csv, 'products.csv');
            showToast('Products exported successfully!', 'success');
        }

        function exportOrders() {
            const ordersData = orders.map(order => ({
                id: order.id,
                customer: `${order.user.firstName} ${order.user.lastName}`,
                email: order.user.email,
                total: order.total,
                status: order.status,
                items: order.items.length,
                date: new Date(order.createdAt).toLocaleDateString()
            }));
            const csv = convertToCSV(ordersData, ['id', 'customer', 'email', 'total', 'status', 'items', 'date']);
            downloadCSV(csv, 'orders.csv');
            showToast('Orders exported successfully!', 'success');
        }

        function exportUsers() {
            const usersData = users.map(user => ({
                id: user.id,
                name: `${user.firstName} ${user.lastName}`,
                email: user.email,
                role: user.role,
                joined: new Date(user.createdAt).toLocaleDateString()
            }));
            const csv = convertToCSV(usersData, ['id', 'name', 'email', 'role', 'joined']);
            downloadCSV(csv, 'users.csv');
            showToast('Users exported successfully!', 'success');
        }

        function convertToCSV(data, headers) {
            if (data.length === 0) return '';
            
            const csvHeaders = headers.join(',');
            const csvRows = data.map(row => 
                headers.map(header => {
                    const value = row[header];
                    return typeof value === 'string' && value.includes(',') ? `"${value}"` : value;
                }).join(',')
            );
            
            return [csvHeaders, ...csvRows].join('\n');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function printOrder() {
            window.print();
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;

            let toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
                document.body.appendChild(toastContainer);
            }

            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
            bsToast.show();

            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('authToken');
                window.location.href = 'login.html';
            }
        }

        // Add event listeners for search and filter inputs
        document.addEventListener('DOMContentLoaded', function() {
            const productSearchInput = document.getElementById('productSearchInput');
            if (productSearchInput) {
                productSearchInput.addEventListener('keyup', function(e) {
                    if (e.key === 'Enter') {
                        filterProducts();
                    }
                });
            }
            
            const orderSearchInput = document.getElementById('orderSearchInput');
            if (orderSearchInput) {
                orderSearchInput.addEventListener('keyup', function(e) {
                    if (e.key === 'Enter') {
                        filterOrders();
                    }
                });
            }
            
            const userSearchInput = document.getElementById('userSearchInput');
            if (userSearchInput) {
                userSearchInput.addEventListener('keyup', function(e) {
                    if (e.key === 'Enter') {
                        filterUsers();
                    }
                });
            }
        });
    </script>
</body>
</html>