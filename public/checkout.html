<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - ShopZone</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-shopping-bag me-2"></i>ShopZone
            </a>
            <div class="navbar-nav ms-auto flex-row">
                <a class="nav-link me-3" href="index.html">
                    <i class="fas fa-home me-1"></i>Home
                </a>
                <a class="nav-link me-3" href="cart.html">
                    <i class="fas fa-shopping-cart me-1"></i>Cart
                </a>
                <a class="nav-link" href="login.html" id="authLink">
                    <i class="fas fa-user me-1"></i>Login
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <!-- Checkout Steps -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="step active">
                                <span class="step-number">1</span>
                                <span class="step-text">Shipping Details</span>
                            </div>
                            <div class="step">
                                <span class="step-number">2</span>
                                <span class="step-text">Payment</span>
                            </div>
                            <div class="step">
                                <span class="step-number">3</span>
                                <span class="step-text">Review</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Checkout Form -->
                <form id="checkoutForm">
                    <!-- Shipping Information -->
                    <div id="shippingStep" class="checkout-step">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5><i class="fas fa-truck me-2"></i>Shipping Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">First Name</label>
                                        <input type="text" class="form-control" id="shippingFirstName" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Last Name</label>
                                        <input type="text" class="form-control" id="shippingLastName" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" id="shippingEmail" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Phone</label>
                                    <input type="tel" class="form-control" id="shippingPhone" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Address</label>
                                    <input type="text" class="form-control" id="shippingAddress" required>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">City</label>
                                        <input type="text" class="form-control" id="shippingCity" required>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label">State</label>
                                        <input type="text" class="form-control" id="shippingState" required>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label">ZIP Code</label>
                                        <input type="text" class="form-control" id="shippingZip" required>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-end">
                                    <button type="button" class="btn btn-primary" onclick="nextStep()">
                                        Continue to Payment <i class="fas fa-arrow-right ms-2"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Information -->
                    <div id="paymentStep" class="checkout-step" style="display: none;">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5><i class="fas fa-credit-card me-2"></i>Payment Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Payment Method</label>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="radio" name="paymentMethod" id="creditCard" value="credit_card" checked>
                                        <label class="form-check-label" for="creditCard">
                                            <i class="fas fa-credit-card me-2"></i>Credit Card
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="radio" name="paymentMethod" id="debitCard" value="debit_card">
                                        <label class="form-check-label" for="debitCard">
                                            <i class="fas fa-credit-card me-2"></i>Debit Card
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="radio" name="paymentMethod" id="upi" value="upi">
                                        <label class="form-check-label" for="upi">
                                            <i class="fas fa-mobile-alt me-2"></i>UPI
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="paymentMethod" id="cod" value="cod">
                                        <label class="form-check-label" for="cod">
                                            <i class="fas fa-money-bill-wave me-2"></i>Cash on Delivery
                                        </label>
                                    </div>
                                </div>

                                <div id="cardDetails">
                                    <div class="mb-3">
                                        <label class="form-label">Card Number</label>
                                        <input type="text" class="form-control" id="cardNumber" placeholder="1234 5678 9012 3456">
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Expiry Date</label>
                                            <input type="text" class="form-control" id="expiryDate" placeholder="MM/YY">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">CVV</label>
                                            <input type="text" class="form-control" id="cvv" placeholder="123">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Cardholder Name</label>
                                        <input type="text" class="form-control" id="cardholderName">
                                    </div>
                                </div>

                                <div id="upiDetails" style="display: none;">
                                    <div class="mb-3">
                                        <label class="form-label">UPI ID</label>
                                        <input type="text" class="form-control" id="upiId" placeholder="username@upi">
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-outline-secondary" onclick="previousStep()">
                                        <i class="fas fa-arrow-left me-2"></i>Back to Shipping
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="nextStep()">
                                        Review Order <i class="fas fa-arrow-right ms-2"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Order Review -->
                    <div id="reviewStep" class="checkout-step" style="display: none;">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5><i class="fas fa-check-circle me-2"></i>Order Review</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Shipping Address</h6>
                                        <div id="reviewShipping" class="mb-3">
                                            <!-- Shipping details will be populated here -->
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Payment Method</h6>
                                        <div id="reviewPayment" class="mb-3">
                                            <!-- Payment details will be populated here -->
                                        </div>
                                    </div>
                                </div>
                                
                                <h6>Order Items</h6>
                                <div id="reviewItems" class="mb-4">
                                    <!-- Order items will be populated here -->
                                </div>

                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-outline-secondary" onclick="previousStep()">
                                        <i class="fas fa-arrow-left me-2"></i>Back to Payment
                                    </button>
                                    <button type="submit" class="btn btn-success" id="placeOrderBtn">
                                        <i class="fas fa-shopping-cart me-2"></i>Place Order
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Order Summary Sidebar -->
            <div class="col-lg-4">
                <div class="card sticky-top" style="top: 20px;">
                    <div class="card-header">
                        <h5>Order Summary</h5>
                    </div>
                    <div class="card-body">
                        <div id="orderSummaryItems">
                            <!-- Order items will be loaded here -->
                        </div>
                        
                        <hr>
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span>₹<span id="summarySubtotal">0.00</span></span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Tax (8.5%):</span>
                            <span>₹<span id="summaryTax">0.00</span></span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Shipping:</span>
                            <span id="summaryShipping">₹0.00</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between">
                            <strong>Total:</strong>
                            <strong class="text-primary">₹<span id="summaryTotal">0.00</span></strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Confirmation Modal -->
    <div class="modal fade" id="orderConfirmationModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-5">
                    <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                    <h4 class="mt-3 mb-3">Order Placed Successfully!</h4>
                    <p class="text-muted mb-4">Thank you for your purchase. You will receive an email confirmation shortly.</p>
                    <div class="mb-4">
                        <strong>Order ID: <span id="confirmationOrderId">#12345</span></strong>
                    </div>
                    <div class="d-flex justify-content-center gap-3">
                        <a href="index.html" class="btn btn-primary">Continue Shopping</a>
                        <!-- <a href="admin.html" class="btn btn-outline-primary">View Orders</a> -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="graphql.js"></script>
    
    <script>
        let currentStep = 1;
        let checkoutData = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadCheckoutData();
            setupPaymentMethodChange();
            setupCheckoutForm();
            updateAuthLinks();
        });

        function loadCheckoutData() {
            checkoutData = JSON.parse(localStorage.getItem('checkoutData') || '{}');
            
            if (!checkoutData.items || checkoutData.items.length === 0) {
                alert('Your cart is empty. Redirecting to shop...');
                window.location.href = 'index.html';
                return;
            }
            
            populateOrderSummary();
            prefillUserData();
        }

        function populateOrderSummary() {
            const itemsContainer = document.getElementById('orderSummaryItems');
            
            itemsContainer.innerHTML = checkoutData.items.map(item => `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <div class="bg-light d-flex align-items-center justify-content-center" style="width: 50px; height: 50px; border-radius: 5px;">
                                <i class="fas fa-image text-muted"></i>
                            </div>
                        </div>
                        <div>
                            <h6 class="mb-1">${item.name}</h6>
                            <small class="text-muted">Qty: ${item.quantity}</small>
                        </div>
                    </div>
                    <div class="text-end">
                        <span>₹${(parseFloat(item.price) * item.quantity).toFixed(2)}</span>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('summarySubtotal').textContent = checkoutData.subtotal.toFixed(2);
            document.getElementById('summaryTax').textContent = checkoutData.tax.toFixed(2);
            document.getElementById('summaryShipping').textContent = checkoutData.shipping === 0 ? 'FREE' : `₹${checkoutData.shipping.toFixed(2)}`;
            document.getElementById('summaryTotal').textContent = checkoutData.total.toFixed(2);
        }

        function prefillUserData() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            if (currentUser.firstName) {
                document.getElementById('shippingFirstName').value = currentUser.firstName;
                document.getElementById('shippingLastName').value = currentUser.lastName;
                document.getElementById('shippingEmail').value = currentUser.email;
                document.getElementById('shippingPhone').value = currentUser.phone || '';
            }
        }

        function setupPaymentMethodChange() {
            const paymentMethods = document.querySelectorAll('input[name="paymentMethod"]');
            paymentMethods.forEach(method => {
                method.addEventListener('change', function() {
                    const cardDetails = document.getElementById('cardDetails');
                    const upiDetails = document.getElementById('upiDetails');
                    
                    if (this.value === 'upi') {
                        cardDetails.style.display = 'none';
                        upiDetails.style.display = 'block';
                    } else if (this.value === 'cod') {
                        cardDetails.style.display = 'none';
                        upiDetails.style.display = 'none';
                    } else {
                        cardDetails.style.display = 'block';
                        upiDetails.style.display = 'none';
                    }
                });
            });
        }

        function setupCheckoutForm() {
            document.getElementById('checkoutForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await placeOrder();
            });
        }

        function nextStep() {
            if (currentStep === 1) {
                if (!validateShippingForm()) return;
                showStep(2);
            } else if (currentStep === 2) {
                if (!validatePaymentForm()) return;
                populateReviewStep();
                showStep(3);
            }
        }

        function previousStep() {
            if (currentStep === 2) {
                showStep(1);
            } else if (currentStep === 3) {
                showStep(2);
            }
        }

        function showStep(step) {
            // Hide all steps
            document.querySelectorAll('.checkout-step').forEach(stepEl => {
                stepEl.style.display = 'none';
            });
            
            // Update step indicators
            document.querySelectorAll('.step').forEach((stepEl, index) => {
                stepEl.classList.toggle('active', index + 1 <= step);
            });
            
            // Show current step
            const stepNames = ['', 'shipping', 'payment', 'review'];
            document.getElementById(stepNames[step] + 'Step').style.display = 'block';
            currentStep = step;
        }

        function validateShippingForm() {
            const required = ['shippingFirstName', 'shippingLastName', 'shippingEmail', 'shippingPhone', 'shippingAddress', 'shippingCity', 'shippingState', 'shippingZip'];
            
            for (let field of required) {
                const element = document.getElementById(field);
                if (!element.value.trim()) {
                    element.focus();
                    showToast('Please fill in all shipping information', 'danger');
                    return false;
                }
            }
            
            return true;
        }

        function validatePaymentForm() {
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            
            if (paymentMethod === 'upi') {
                const upiId = document.getElementById('upiId').value.trim();
                if (!upiId || !upiId.includes('@')) {
                    document.getElementById('upiId').focus();
                    showToast('Please enter a valid UPI ID', 'danger');
                    return false;
                }
            } else if (paymentMethod !== 'cod') {
                const cardNumber = document.getElementById('cardNumber').value.trim();
                const expiryDate = document.getElementById('expiryDate').value.trim();
                const cvv = document.getElementById('cvv').value.trim();
                
                if (!cardNumber || !expiryDate || !cvv) {
                    showToast('Please fill in all card details', 'danger');
                    return false;
                }
            }
            
            return true;
        }

        function populateReviewStep() {
            // Shipping address review
            const shippingReview = `
                ${document.getElementById('shippingFirstName').value} ${document.getElementById('shippingLastName').value}<br>
                ${document.getElementById('shippingAddress').value}<br>
                ${document.getElementById('shippingCity').value}, ${document.getElementById('shippingState').value} ${document.getElementById('shippingZip').value}<br>
                Phone: ${document.getElementById('shippingPhone').value}<br>
                Email: ${document.getElementById('shippingEmail').value}
            `;
            document.getElementById('reviewShipping').innerHTML = shippingReview;
            
            // Payment method review
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
            let paymentReview = '';
            
            switch (paymentMethod.value) {
                case 'credit_card':
                    paymentReview = `Credit Card ending in ${document.getElementById('cardNumber').value.slice(-4)}`;
                    break;
                case 'debit_card':
                    paymentReview = `Debit Card ending in ${document.getElementById('cardNumber').value.slice(-4)}`;
                    break;
                case 'upi':
                    paymentReview = `UPI: ${document.getElementById('upiId').value}`;
                    break;
                case 'cod':
                    paymentReview = 'Cash on Delivery';
                    break;
            }
            document.getElementById('reviewPayment').innerHTML = paymentReview;
            
            // Order items review
            const itemsReview = checkoutData.items.map(item => `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <span>${item.name}</span>
                        <small class="text-muted"> x ${item.quantity}</small>
                    </div>
                    <span>₹${(parseFloat(item.price) * item.quantity).toFixed(2)}</span>
                </div>
            `).join('');
            document.getElementById('reviewItems').innerHTML = itemsReview;
        }

        async function placeOrder() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');

            if (!currentUser.id) {
                alert('Please login to place an order');
                window.location.href = 'login.html';
                return;
            }

            const placeOrderBtn = document.getElementById('placeOrderBtn');
            placeOrderBtn.disabled = true;
            placeOrderBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Placing Order...';

            try {
                // Get payment method
                const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;

                // Prepare shipping address as JSON string
                const shippingAddress = JSON.stringify({
                    street: document.getElementById('shippingAddress').value,
                    city: document.getElementById('shippingCity').value,
                    state: document.getElementById('shippingState').value,
                    zipCode: document.getElementById('shippingZip').value,
                    country: 'India' // Assuming country is India
                });

                // Use GraphQLService to create order
                const order = await window.graphqlService.createOrder(shippingAddress, paymentMethod);

                // Show success modal
                document.getElementById('confirmationOrderId').textContent = `#${order.id.slice(-8)}`;
                const modal = new bootstrap.Modal(document.getElementById('orderConfirmationModal'));
                modal.show();

                // Clear cart and checkout data
                localStorage.removeItem('cart');
                localStorage.removeItem('checkoutData');

                // Update cart count
                if (window.shopZone) {
                    window.shopZone.cart = [];
                    window.shopZone.updateCartCount();
                }

            } catch (error) {
                console.error('Error placing order:', error);
                showToast('Failed to place order: ' + error.message, 'danger');
            } finally {
                placeOrderBtn.disabled = false;
                placeOrderBtn.innerHTML = '<i class="fas fa-shopping-cart me-2"></i>Place Order';
            }
        }

        function updateAuthLinks() {
            const authLink = document.getElementById('authLink');
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
            
            if (authLink) {
                if (currentUser) {
                    authLink.innerHTML = '<i class="fas fa-user me-1"></i>Account';
                    if (currentUser.role === 'admin') {
                        authLink.href = 'admin.html';
                    } else {
                        authLink.href = 'profile.html';
                    }
                } else {
                    authLink.innerHTML = '<i class="fas fa-user me-1"></i>Login';
                    authLink.href = 'login.html';
                }
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;

            let toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
                document.body.appendChild(toastContainer);
            }

            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
            bsToast.show();

            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }
    </script>

    <style>
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .step.active .step-number {
            background-color: #007bff;
            color: white;
        }
        
        .step-text {
            font-size: 0.875rem;
            color: #6c757d;
        }
        
        .step.active .step-text {
            color: #007bff;
            font-weight: 600;
        }
        
        .checkout-step {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</body>
</html>